<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">
</head>
<body>

    <div class="container text-center">
        <div class="row" id="gridRow">

        </div>
      </div>

    
    <script>

        var deviceIdList=[];

        function connectWebsocket(){
            var socket=new WebSocket("ws://"+window.location.host+"/device/");
            socket.onmessage=function(event){
                console.log(event.data);
                data=JSON.parse(event.data);
                deviceId=data["deviceId"];

                let statusDoc=document.getElementById(deviceId.toString()+"s");
                statusDoc.innerHTML=data["status"]==false? "Off":"On";
                statusDoc.className=data["status"]==false? "text-danger":"text-success";
                
                document.getElementById(deviceId.toString()+"v").innerHTML=data["voltage"];
                document.getElementById(deviceId.toString()+"c").innerHTML=data["current"];
                document.getElementById(deviceId.toString()+"p").innerHTML=data["power"];
                document.getElementById(deviceId.toString()+"modified").innerHTML=data["modified"];
            };
        }

        window.onload=function(){
            var deviceListRequest=new XMLHttpRequest();
            deviceListRequest.open("GET","/device/all");
            deviceListRequest.onreadystatechange =function(){
            if(deviceListRequest.status==200 && deviceListRequest.readyState == 4){
                console.log(deviceListRequest.response);

                let json=JSON.parse(deviceListRequest.response);
                deviceIdList=json["devices"];
                
                connectWebsocket();

                for(let i=0;i<deviceIdList.length;i++){
                    console.log('device'+(i+1).toString());
                                      

                    let card="\
                        <div class='card' style='width: 18rem;'>\
                            <div class='card-body'>\
                            <h5 class='card-title'>Device : "+deviceIdList[i].toString()+"</h5>\
                            <p class='card-text'>\
                                <ul class='list-group'>\
                                    <li class='list-group-item d-flex justify-content-between align-items-center' >Status<span id='"+deviceIdList[i].toString()+"s'></span></li>\
                                    <li class='list-group-item d-flex justify-content-between align-items-center'>Voltage (V)<span id='"+deviceIdList[i].toString()+"v' ></span></li>\
                                    <li class='list-group-item d-flex justify-content-between align-items-center'>current (A)<span id='"+deviceIdList[i].toString()+"c'></span></li>\
                                    <li class='list-group-item d-flex justify-content-between align-items-center bg-primary text-white'>Power (W)<span id='"+deviceIdList[i].toString()+"p'></span></li>\
                                </ul>\
                            </p>\
                            <p class='card-footer'>Last Updated on <span id='"+deviceIdList[i].toString()+"modified' class='text-secondary'></span></p>\
                            </div>\
                        </div>";
                    
                    let node=document.createElement('div');
                    node.innerHTML=card;
                    node.className="col";
                    document.querySelector("#gridRow").appendChild(node);
                    

                }


                }
            }
            deviceListRequest.send();
        }



        
    </script>
</body>
</html>